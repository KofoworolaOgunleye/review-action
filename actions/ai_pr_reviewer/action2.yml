name: "AI PR Reviewer"
description: "Run an AI-based review on a pull request and post a comment with the results."

inputs:
  openai_api_key:
    description: 'OpenAI API key.'
    required: true
  github_token:
    description: 'GitHub token.'
    required: false
    default: ${{ github.token }}

runs:
  using: 'composite'
  steps:
    - name: Create ai-review label if it doesn't exist
      uses: actions/github-script@v7
      with:
          github-token: ${{ inputs.github_token }}
          script: |
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'ai-review'
              });
              console.log('Label ai-review already exists');
            } catch (error) {
              if (error.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'ai-review',
                  description: 'Trigger AI code review',
                  color: '6def69'
                });
                console.log('Created ai-review label');
              } else {
                throw error;
              }
            }

    # - name: Add ai-review label to PR
    #   if: github.event.pull_request.body && contains(github.event.pull_request.body, '/ai-review')
    #   uses: actions/github-script@v7
    #   with:
    #       github-token: ${{ inputs.github_token }}
    #       script: |
    #         await github.rest.issues.addLabels({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           issue_number: context.issue.number,
    #           labels: ['ai-review']
    #         });
          
    - name: Check if ai-review label exists on PR
      id: check-label
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const labels = context.payload.pull_request.labels.map(label => label.name);
          const hasAiReviewLabel = labels.includes('ai-review');
          core.setOutput('has-ai-review-label', hasAiReviewLabel);
          return hasAiReviewLabel;

    - name: Checkout repo
      if: steps.check-label.outputs.has-ai-review-label == 'true'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      if: steps.check-label.outputs.has-ai-review-label == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      if: steps.check-label.outputs.has-ai-review-label == 'true'
      shell: bash
      working-directory: ${{ github.action_path }}
      run: npm ci && npm run build

    # - name: Build
    #   shell: bash
    #   working-directory: ${{ github.action_path }}
    #   run: npm run build

    - name: Get PR diff
      if: steps.check-label.outputs.has-ai-review-label == 'true'
      shell: bash
      run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr.diff
          echo "Diff saved to pr.diff"

    - name: Run AI review
      if: steps.check-label.outputs.has-ai-review-label == 'true'
      shell: bash
      env:
        OPENAI_API_KEY: ${{ inputs.openai_api_key }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        node ${{ github.action_path }}/dist/reviewPr.js
